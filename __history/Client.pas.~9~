unit Client;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StdCtrls, NiceGrid, ExtCtrls, DB, ADODB, IniFiles,
  lhjModule ,ClipBrd ;

type
  TFormClient = class(TForm)
    ADOConnection1: TADOConnection;
    ADOQuery1: TADOQuery;
    DataSource1: TDataSource;
    Panel1: TPanel;
    Label14: TLabel;
    NiceGrid1: TNiceGrid;
    GroupBox8: TGroupBox;
    ButtonClient1: TButton;
    ButtonClient2: TButton;
    ButtonClient3: TButton;
    ButtonClientEnd: TButton;
    GroupBox1: TGroupBox;
    Label12: TLabel;
    Label13: TLabel;
    Label20: TLabel;
    Edit1: TEdit;
    Edit2: TEdit;
    Edit3: TEdit;
    Edit4: TEdit;
    Edit5: TEdit;
    Edit6: TEdit;
    Edit12: TEdit;
    Edit8: TEdit;
    Label1: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label7: TLabel;
    Memo1: TMemo;
    Edit11: TEdit;
    Label2: TLabel;
    Label3: TLabel;
    Edit7: TEdit;
    GroupBox2: TGroupBox;
    EditFind: TEdit;
    ButtonFind: TButton;
    ButtonFindCancel: TButton;
    Edit9: TEdit;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    Label15: TLabel;
    Label16: TLabel;
    Edit10: TEdit;
    Edit19: TEdit;
    Edit17: TEdit;
    Edit18: TEdit;
    Label8: TLabel;
    Edit13: TEdit;
    Edit14: TEdit;
    Edit15: TEdit;
    Edit16: TEdit;
    Label17: TLabel;
    Label18: TLabel;
    Label19: TLabel;
    NiceGridSync1: TNiceGridSync;
    procedure FormActivate(Sender: TObject);
    procedure ButtonClientEndClick(Sender: TObject);
    procedure ClientManager;
    procedure NiceGrid1DrawCell(Sender: TObject; ACanvas: TCanvas; X,
      Y: Integer; Rc: TRect; var Handled: Boolean);
    procedure NiceGrid1KeyDown(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure EditFindKeyPress(Sender: TObject; var Key: Char);
    procedure Grid_Listing_Client(NGrid : TNiceGrid; Ssql: Ansistring);
    procedure ButtonFindClick(Sender: TObject);
    procedure ButtonFindCancelClick(Sender: TObject);
    procedure DetailView(iRow : integer);
    procedure NiceGrid1Click(Sender: TObject);
    //procedure ButtonCharge3Click(Sender: TObject);
    //procedure ButtonCharge2Click(Sender: TObject);
    //procedure ButtonCharge1Click(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure MakeBoHum();
    //procedure Button2Click(Sender: TObject);
    procedure ButtonClient3Click(Sender: TObject);
    procedure ButtonClient2Click(Sender: TObject);
    procedure ButtonClient1Click(Sender: TObject);
    procedure NiceGridSync1DrawCell(Sender: TObject; ACanvas: TCanvas; X,
      Y: Integer; Rc: TRect; var Handled: Boolean);
    Procedure Text_Init(Index : Integer);
    Procedure Grid_Init(Index : Integer);

  private
    { Private declarations }
    procedure BoHumDblClick(Sender: TObject);
  public
    { Public declarations }
  end;

var
  FormClient    : TFormClient;
  //FormSecurity  : TFormCharge;
implementation

{$R *.dfm}

var
  FindFlag    : Boolean;            //  검색mode = True
  NGrid       : TNiceGrid;
  DBLIST1     : ansistring;
//==================================================================
// Name      : FormActivate
// Desc      : Form 초기화
//==================================================================
procedure TFormClient.FormActivate(Sender: TObject);
begin
  //FormClient.Position := poMainFormCenter;
  ADOQuery1.Connection.LoginPrompt:=False;
  FindFlag  := False;
  Grid_Init(0);
  Text_Init(0);
  Text_Init(71); // find
  dblist1 := 'ID, 거래처이름, 핸드폰, 구분, 상호, 성명, 사업자번호, 개업일, ' +
             '전화1, 전화2, 팩스, 메일, 업태, 종목, 과세여부, 생일, 계좌1, ' +
             '계좌2, 주소, 비고 ';
  ClientManager;
  //editfind.SetFocus;

end;

//==================================================================
// Name      : ButtonFindCancelClick
// Desc      : find- cancel
//==================================================================
procedure TFormClient.ButtonFindCancelClick(Sender: TObject);
begin
  formactivate(nil);
end;
//==================================================================
// Name      : ButtonFindClick
// Desc      : Find
//==================================================================
procedure TFormClient.ButtonFindClick(Sender: TObject);
var
  cFinder : ansistring;
  Ssql    : AnsiString;
begin
  cFinder := editfind.Text;
  if bNULL(cFinder) then begin
    showmessage('찾을 이름을 입력하세요');
  end
  else begin
    Ssql:='SELECT ID, 보험사, 담당, 이름, 직위, 핸드폰, FAX, 메일, 사무실, ' +
        '콜센타, 메모 ' + ' From 보험담당 ' +
        'WHERE 이름 LIKE ' + QQ + '%' + cFinder + '' + QQ  +
        'ORDER BY 보험사 asc, 이름 ASC ;' ;
    Grid_Listing_Client(NiceGrid1,Ssql);
  end;
  editfind.SelectAll  ; //editfind.SetFocus;

end;
//==================================================================
// Name      : ClientManager
// Desc      : Manager
//==================================================================
procedure TFormClient.ClientManager;
var
  Ssql    : AnsiString;
begin
  Ssql:='SELECT ' + DBLIST1 + ' From 거래처 ORDER BY 거래처이름 asc, 성명 ASC ;' ;
  Grid_Listing_Client(NiceGrid1,Ssql);
end;

//==================================================================
// Name      : Grid_Listing_Client
// Desc      : NiceGrid에 쿼리문 받아서 뿌려주는 함수
//==================================================================
procedure TFormClient.Grid_Listing_Client(NGrid : TNiceGrid; Ssql: Ansistring);
var
  i,j       : Integer;
  SGridS    : TNiceGridSync;
begin
  //
  sGrids  :=NiceGridSync1;
  //
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.Text:=(Ssql);
  ADOQuery1.Open;
  ngrid.Clear;
  if ADOQuery1.Recordset.RecordCount>0 then
   begin
    i:=0;
    NGrid.BeginUpdate;
    sgrids.BeginUpdate;
    NGrid.RowCount:=ADOQuery1.Recordset.RecordCount;
    while not ADOQuery1.Eof do
    begin
      with ADOQuery1.Recordset.Fields do
       begin
        for j := 0 to ADOQuery1.Recordset.Fields.Count - 1 do begin
           case j of
           0, 1: SGrids[j,i] := ifNULL(Item[j].Value,'');
           else  NGrid[j,i]  := ifNULL(Item[j].Value,'');
           end;

        end;
       end; // with
      inc(i);
      ADOQuery1.Next;
    end; // while
    NGrid.EndUpdate;
    sgrids.EndUpdate;
   end; // if
  ADOQuery1.Active:=False;

end;


//==================================================================
// Name      : EditFindKeyPress
// Desc      : fidn enter / esc key press
//==================================================================
procedure TFormClient.EditFindKeyPress(Sender: TObject; var Key: Char);
begin
  if key= #13 then buttonfind.Click;
  if key= #27 then buttonfindcancel.Click;


end;

//==================================================================
// Name      : Text_Init
// Desc      : 텍스트 박스 초기화
//==================================================================
Procedure TFormClient.Text_Init(Index : Integer);
var
  i   : Integer;
  TComp : TComponent; //Tedit;
begin
  case Index of
  0: begin
      // ------------------- 세부정보 초기화
      for i := 0 to GroupBox1.ControlCount - 1 do  // 세부정보 - 전체
      begin
        TComp :=GroupBox1.Controls[i];
        if TComp.ClassName ='TEdit' then begin
          Tedit(GroupBox1.Controls[i]).text :='';
          Tedit(GroupBox1.Controls[i]).Height:=16;
        end;  // if
        if Tcomp.ClassName='TMemo' then TMemo(GroupBox1.Controls[i]).text :='';
      end; // for
     end;
  71: begin // find
      editFind.Text := '';

    end;
  end;

end;

//==================================================================
// Name      : Grid_Init
// Desc      : 그리드 초기화
//==================================================================
procedure TFormClient.Grid_Init(Index : Integer);
begin
  // 그리드 초기화
  with NiceGrid1 do begin
    ColCount     := 18;
    Color        := clWindow;
    DefRowHeight := 18;
    Font.Name    := '굴림체';
    Font.Size    := 8;
    GutterWidth  := 0;
    GutterKind   := gkNumber;
    GutterFont.Name:='Minion Pro';
    GutterFont.Size:=9;
    Height       := 288;
    RowCount     :=1;
    ShowFooter   :=False;
    ShowGrid     :=True;
    Width        := 755;
    {Columns[0].Title:='ID';       Columns[0].Width  :=80;
    Columns[1].Title:='보험사';   Columns[1].Width  :=88;
    Columns[2].Title:='담당';     Columns[2].Width  :=48;
    Columns[3].Title:='이름';     Columns[3].Width  :=80;
    Columns[4].Title:='직위';     Columns[4].Width  :=48;
    Columns[5].Title:='핸드폰';   Columns[5].Width  :=85;
    Columns[6].Title:='FAX';      Columns[6].Width  :=90;
    Columns[7].Title:='메일주소'; Columns[7].Width  :=100;
    Columns[8].Title:='사무실';   Columns[8].Width  :=85;
    Columns[9].Title:='콜센터';   Columns[9].Width  :=85;
    Columns[10].Title:='메모';    Columns[10].Width :=110;}
    Clear;
  end; // with
  with NiceGridSync1 do begin
    ColCount     := 2;
    Color        := clWindow;
    DefRowHeight := 18;
    Font.Name    := '굴림체';
    Font.Size    := 8;
    Grid         := NiceGrid1;
    GutterWidth  := 22;
    GutterKind   := gkNumber;
    GutterFont.Name:='Minion Pro';
    GutterFont.Size:=9;
    Height       := 288;
    RowCount     :=1;
    ShowFooter   :=False;
    ShowGrid     :=True;
    Width        := 207;
    Columns[0].Title:='ID';         Columns[0].Width  :=90;
    Columns[1].Title:='거래처명';   Columns[1].Width  :=92;
    Clear;
  end;
end;

//==================================================================
// Name      : NiceGrid1DrawCell
// Desc      : 그리드 color
//==================================================================
procedure TFormClient.NiceGrid1DrawCell(Sender: TObject; ACanvas: TCanvas; X,
  Y: Integer; Rc: TRect; var Handled: Boolean);
var
  i: Integer;
begin
  //(y and 1) =0 짝수  , =1  홀수  bit연산이고 끝에 이진수 1더해짝수/홀수 구분
  if (y and 1) =0 then begin
    for i := 0 to Nicegrid1.ColCount - 1 do begin
      ACanvas.Brush.Color := clGradientActiveCaption;
    end; // for
  end
  else begin
    for i := 0 to Nicegrid1.ColCount - 1 do begin
      ACanvas.Brush.Color := clGradientInactiveCaption;
    end; // for
  end;  // if
end;

//==================================================================
// Name      : NiceGrid1DrawCell
// Desc      : 그리드 color
//==================================================================
procedure TFormClient.NiceGridSync1DrawCell(Sender: TObject; ACanvas: TCanvas;
  X, Y: Integer; Rc: TRect; var Handled: Boolean);
var
  i: Integer;
begin
  //(y and 1) =0 짝수  , =1  홀수  bit연산이고 끝에 이진수 1더해짝수/홀수 구분
  if (y and 1) =0 then begin
    for i := 0 to NiceGridSync1.ColCount - 1 do begin
      ACanvas.Brush.Color := clGradientActiveCaption;
    end; // for
  end
  else begin
    for i := 0 to NiceGridSync1.ColCount - 1 do begin
      ACanvas.Brush.Color := clGradientInactiveCaption;
    end; // for
  end;  // if
end;



//==================================================================
// Name      : NiceGrid1Click
// Desc      : Grid Select
//==================================================================
procedure TFormClient.NiceGrid1Click(Sender: TObject);
begin
  DetailView(NiceGrid1.Row);
end;

//==================================================================
// Name      : NiceGrid1KeyDown
// Desc      : Grid Select
//==================================================================
procedure TFormClient.NiceGrid1KeyDown(Sender: TObject; var Key: Word;
  Shift: TShiftState);
begin
   //showmessage ('KeyDown ' + floattostr(key));
  case Key of
    VK_UP,VK_DOWN,VK_PRIOR,VK_NEXT : DetailView(NiceGrid1.Row);
  end;
end;

//==================================================================
// Name      : DetailView
// Desc      :
//==================================================================
procedure TFormClient.DetailView(iRow : integer);
var
  i   : integer;
begin
  edit1.Text := NiceGrid1[00,irow];
  edit2.Text := NiceGrid1[01,irow];
  edit3.Text := NiceGrid1[02,irow];
  edit4.Text := NiceGrid1[03,irow];
  edit5.Text := NiceGrid1[04,irow];
  edit6.Text := NiceGrid1[05,irow];
  edit7.Text := NiceGrid1[06,irow];
  edit8.Text := NiceGrid1[07,irow];
  edit9.Text := NiceGrid1[08,irow];
  edit10.Text:= NiceGrid1[09,irow];
  memo1.Text := NiceGrid1[10,irow];

end;


//==================================================================
// Name      : Button1Click
// Desc      : MakeBoHum  - listbox
//==================================================================
procedure TFormClient.Button1Click(Sender: TObject);
begin
  MakeBoHum;
end;
//==================================================================
// Name      : MakeBoHum
// Desc      : 보험사 뷰어
//==================================================================
procedure TFormClient.MakeBoHum();
var
  i,bCnt    : integer;
  Ssql      : AnsiString;
  FileName  : Ansistring;
  iniSet    : TIniFile;
  bList     : Ansistring;
  iLen,iPos : integer;
begin
  with TListBox.Create(FormClient) do begin
    Parent  := Panel1;
    Left   := 100;
    Top    := 26 + 58 + 9;
    Height := 450;
    Width  := 255;
    Font.Name := '맑은 고딕';
    Font.Size := 11;
    Name   := 'ListBoxBoHum';
    OnDblClick := BoHumDblClick;

    FileName:='.\' + 'SCM1.ini';
    iniSet := TIniFile.Create(ChangeFileExt(FileName, '.ini'));
    //try
      bCnt  := iniSet.ReadInteger('보험사리스트', 'Count', 1);
      bList := iniSet.ReadString ('보험사리스트', '보험사', 'New Form');
    //============================================================
      i:=0;
      ilen:=length(widestring(bList));
      ipos:=pos(',',widestring(bList));
      while ipos>0 do begin
        inc(i);
        Items.Add(copy(widestring(bList),0,ipos-1));
        bList:= copy(widestring(bList),ipos+1,ilen-1);
        ilen:=length(widestring(bList));
        ipos:=pos(',',widestring(bList));
      end; // while
      Items.Add(bList);
    //finally
      iniSet.Free;
   // end;  // try
  end; // with
end;

//==================================================================
// Name      : BoHumDblClick
// Desc      : 보험사 뷰어 - ListBox select process
//==================================================================
procedure TFormClient.BoHumDblClick(Sender: TObject);
begin
  //
  edit2.Text:=(Sender as TListbox).Items.Strings[(Sender as TListbox).ItemIndex];
  (Sender as TListbox).Free;
end;


//==================================================================
// Name      : ButtonCharge1Click
// Desc      : save
//==================================================================
procedure TFormClient.ButtonClient1Click(Sender: TObject);
var
  Flag      : boolean;
  yn        : integer;
  Ssql      : Ansistring;
  myMessage : AnsiString;
  tmpstr    : ansistring;
begin
  Ssql:='SELECT ID, 보험사, 이름 From 보험담당 ' +
        'WHERE 이름 = ' +  QQ + edit4.Text + QQ  +
        ' AND 보험사 = ' + QQ + edit2.Text + QQ  +
        'ORDER BY 보험사 asc, 이름 ASC ;' ;
  ADOQuery1.SQL.Clear;
  ADOQuery1.SQL.Text:=(Ssql);
  ADOQuery1.Open;
  tmpstr := formatdatetime('yyyymmddhhnnss', now());
  if ADOQuery1.Recordset.RecordCount>0 then begin
    yn:=MessageDlg('동일한 보험사에 같은 이름이 있습니다. 덮어쓰기할까요 ?'
                  ,mtInformation,mbOKCancel,0);   // OK : 1 , Cancel : 2
    if yn=1 then begin
         edit1.Text  := ifNULL(ADOQuery1.Recordset.Fields.Item[0].Value,tmpstr)
    end else begin
      edit1.Text  := tmpstr;
    end; // if
  end else begin
    edit1.Text  := tmpstr;
  end; // if
  ADOQuery1.Active:=False;
//clipboard.AsText:= '[' + edit1.Text +']';
  if (vNULL(edit2.Text)) and (vNULL(edit4.Text)) and (vNULL(edit6.Text)) then
    showmessage('DATA 입력이 완벽하지 않습니다. 다시한번 확인해 주세요...')
  else begin
    Ssql:='SELECT ID, 보험사, 담당, 이름, 직위, 핸드폰, FAX, 메일, 사무실, ' +
        '콜센타, 메모 ' + ' From 보험담당 ' +
        'WHERE ID = ' + QQ + edit1.Text + QQ + ';' ;
    ADOQuery1.SQL.Clear;
    ADOQuery1.SQL.Text:=(Ssql);
    ADOQuery1.Open;
    if ADOQuery1.Eof then begin
      try     // insert
        ADOConnection1.BeginTrans;                     //트랜젝션 시작
        Ssql:='INSERT INTO 보험담당 ' +
          '( ID, 보험사, 담당, 이름, 직위, 핸드폰, FAX, 메일, 사무실, ' +
          '콜센타, 메모 )' +
          ' Values ( ' + QQ +
          ifNULL(edit1.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit2.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit3.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit4.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit5.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit6.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit7.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit8.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit9.Text,'-') + QQ + ', ' + QQ +
          ifNULL(edit10.Text,'-')+ QQ + ', ' + QQ +
          ifNULL(memo1.Text,'-') + QQ + ') ; ';

        ADOQuery1.Close;
        ADOQuery1.SQL.Clear;
        ADOQuery1.SQL.Text:=sSql; //.Add 함수를 사용하면 매우 느려진다. 사용하지 말자.
        myMessage:=' 저장이 완료 되었습니다. ';
      except
        ADOConnection1.RollbackTrans;                 //트랜젝션 롤백
        ADOQuery1.Active:=False; // 예외 처리
      end;  // try
    end  //if ADOQuery1.Eof
    else begin
      try         // update   // ' + MQ + '
        ADOConnection1.BeginTrans;                     //트랜젝션 시작
        Ssql:='UPDATE 보험담당 SET ' +
              'ID     = ' + QQ + ifNULL(edit1.Text,'-') + QQ + ', ' +
              '보험사 = ' + QQ + ifNULL(edit2.Text,'-') + QQ + ', ' +
              '담당   = ' + QQ + ifNULL(edit3.Text,'-') + QQ + ', ' +
              '이름   = ' + QQ + ifNULL(edit4.Text,'-') + QQ + ', ' +
              '직위   = ' + QQ + ifNULL(edit5.Text,'-') + QQ + ', ' +
              '핸드폰 = ' + QQ + ifNULL(edit6.Text,'-') + QQ + ', ' +
              'FAX    = ' + QQ + ifNULL(edit7.Text,'-') + QQ + ', ' +
              '메일   = ' + QQ + ifNULL(edit8.Text,'-') + QQ + ', ' +
              '사무실 = ' + QQ + ifNULL(edit9.Text,'-') + QQ + ', ' +
              '콜센타 = ' + QQ + ifNULL(edit10.Text,'-')+ QQ + ', ' +
              '메모   = ' + QQ + ifNULL(memo1.Text,'-') + QQ + '  ' +
              ' Where ID = ' + QQ + edit1.Text + QQ + ' ;';
        ADOQuery1.Close;
        ADOQuery1.SQL.Clear;
        ADOQuery1.SQL.Text:=sSql; //.Add 함수를 사용하면 매우 느려진다. 사용하지 말자.
        myMessage:=' 저장이 완료 되었습니다. ';
     except
        ADOConnection1.RollbackTrans;                 //트랜젝션 롤백
        ADOQuery1.Active:=False; // 예외 처리
     end;
   end; // if
//clipboard.AsText:=ssql;   //   Ctrl - C    복사  copy  uses => ClipBrd
//showmessage (' ssql = ' + ssql+ '    ' );    clipboard.AsText:=ssql;
  ADOQuery1.ExecSQL;
  ADOConnection1.CommitTrans;                    //트랜젝션 적용
  ADOQuery1.Active:=False;
  ShowMessage (myMessage);
  end; //if
  ClientManager;
end;





//==================================================================
// Name      : ButtonCharge2Click
// Desc      : delete
//==================================================================
procedure TFormClient.ButtonClient2Click(Sender: TObject);
var
  yn : Integer;
  sSql : AnsiString;
  ToDay : AnsiString;
  //FormSecurity:TFormSecurity;
  tString   : string;
begin
  // 삭제 여부 재확인
  yn:=MessageDlg('정말 삭제하겠습니까? 삭제한 자료는 복구가 안됩니다.'
                  ,mtInformation,mbOKCancel,0);   // OK : 1 , Cancel : 2
  if yn=1 then  begin
    {FormSecurity:=TFormSecurity.Create_FormSecurity(tstring, self);

    FormSecurity.ShowModal;
    FormSecurity.Free;
    //if FormSecurity.EditPW.Text=pPW then ResultReturn:='OK'
    //                                else ResultReturn:='FAIL';
    if tString=pPW then ResultReturn:='OK'
                   else ResultReturn:='FAIL';
    if ResultReturn='FAIL' then close;
    }
    sSql := 'DELETE FROM 보험담당 WHERE ID = ' + QQ + edit1.Text + QQ + ';';
// clipboard.AsText:=ssql;   //   Ctrl - C    복사  copy  uses => ClipBrd
    try
      try
        ADOConnection1.BeginTrans;                     //트랜젝션 시작
        ADOQuery1.SQL.Clear;
        ADOQuery1.SQL.Text:=(Ssql);
        ADOQuery1.ExecSQL;
        ADOConnection1.CommitTrans;                    //트랜젝션 적용
      except
        ADOConnection1.RollbackTrans;                 //트랜젝션 롤백
        showmessage(' try exception 예외처리');    ///////////////////////////////////////
      end; // try
    finally
        //ADOQuery1.Open;
        ADOQuery1.Active:=False;
        //showmessage(' try finally 예외처리');       ///////////////////////////////////////
    end;  // try
  end; //if
  Text_Init(0);
  ClientManager;
end;

//==================================================================
// Name      : ButtonClient3Click
// Desc      : 취소 /  Clear
//==================================================================
procedure TFormClient.ButtonClient3Click(Sender: TObject);
begin
  Text_Init(0);
end;

//==================================================================
// Name      : ButtonChargeEndClick
// Desc      : end , close
//==================================================================
procedure TFormClient.ButtonClientEndClick(Sender: TObject);
begin
  close;
end;

end.
